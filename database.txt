-- SHUTTLEUP COCKROACHDB SCHEMA (COMPLETE)
-- Professional Badminton Tournament Management

-- 1. PROFILES & AUTH
CREATE TABLE IF NOT EXISTS profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username STRING UNIQUE NOT NULL,
    full_name STRING NOT NULL,
    password_hash STRING NOT NULL,
    role STRING NOT NULL CHECK (role IN ('superadmin', 'admin', 'player', 'scorer')),
    credits INT8 NOT NULL DEFAULT 500,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 2. TOURNAMENTS
CREATE TABLE IF NOT EXISTS tournaments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    share_id STRING UNIQUE DEFAULT concat('SHTL-', upper(substring(md5(random()::text), 1, 6))),
    name STRING NOT NULL,
    description STRING,
    organizer_id UUID REFERENCES profiles(id),
    status STRING DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'finished', 'cancelled')),
    start_date DATE,
    location_name STRING,
    rules_handbook STRING,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 3. TEAMS
CREATE TABLE IF NOT EXISTS teams (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tournament_id UUID REFERENCES tournaments(id) ON DELETE CASCADE,
    name STRING NOT NULL,
    points INT8 DEFAULT 0,
    wins INT8 DEFAULT 0,
    losses INT8 DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 4. PARTICIPANTS & MEMBERS
CREATE TABLE IF NOT EXISTS tournament_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tournament_id UUID REFERENCES tournaments(id) ON DELETE CASCADE,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    status STRING DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE (tournament_id, user_id)
);

CREATE TABLE IF NOT EXISTS team_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID REFERENCES teams(id) ON DELETE CASCADE,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE (team_id, user_id)
);

-- 5. MATCHES & SCORING
CREATE TABLE IF NOT EXISTS matches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tournament_id UUID REFERENCES tournaments(id) ON DELETE CASCADE,
    team1_id UUID REFERENCES teams(id) ON DELETE CASCADE,
    team2_id UUID REFERENCES teams(id) ON DELETE CASCADE,
    score1 INT8 DEFAULT 0,
    score2 INT8 DEFAULT 0,
    status STRING DEFAULT 'pending' CHECK (status IN ('pending', 'live', 'completed')),
    scheduled_at TIMESTAMPTZ NOT NULL,
    completed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 6. AUDIT & CREDITS
CREATE TABLE IF NOT EXISTS credit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    amount INT8 NOT NULL,
    action_type STRING NOT NULL,
    description STRING,
    created_at TIMESTAMPTZ DEFAULT now()
);